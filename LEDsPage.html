<!DOCTYPE html>

<html>
<head>
  <title>ESP32 LED RGB</title>
  <style>
    body {font-family:Arial; text-align:center; margin:20px;}
    .preview {width:80px; height:80px; margin:10px auto; border-radius:50%;}
  </style>
</head>

<body onload="PedirValores()">
  <h2>Control LED RGB</h2>
  
  <div class="preview" id="preview"></div>
  
  <div>
    <!-- Deslizador-->
    R: <input type="range" min="0" max="255" value="0" id="r" oninput="ActualizarValordelTexto()">
     <!-- Texto que muestra el valor del deslizador -->
    <span id="rv">0</span>
  </div>
  
  <div>
    G: <input type="range" min="0" max="255" value="0" id="g" oninput="ActualizarValordelTexto()">
    <span id="gv">0</span>
  </div>
  
  <div>
    B: <input type="range" min="0" max="255" value="0" id="b" oninput="ActualizarValordelTexto()">
    <span id="bv">0</span>
  </div>

  <div>
     <!-- Checkbox de encendido o apagado-->
     <input type="checkbox" id="Switch" onchange="CambiarValor('Switch')">
     <!-- Texto que indica estado del checkbox-->
    <label id="lblSwitch" for="Switch">Switch Apagado</label>
  </div>
  
  <script>
    //=======================================================================================================================
    let SwitchOn= false;
    
    function ActualizarValordelTexto() {
      const r = document.getElementById('r').value;
      const g = document.getElementById('g').value;
      const b = document.getElementById('b').value;
      
      document.getElementById('rv').textContent = r;
      document.getElementById('gv').textContent = g;
      document.getElementById('bv').textContent = b;
      
      ActualizarVisualizacionDelColor();
      sendRGB(r, g, b);
    }
    
    function ActualizarVisualizacionDelColor() {
    //si[?] r 'on' ->  entonces r='r.value' ->si no, entonces 0
      const r =  document.getElementById('r').value ;
      const g =  document.getElementById('g').value ;
      const b =  document.getElementById('b').value ;
      
      document.getElementById('preview').style.backgroundColor = `rgb(${r},${g},${b})`;
    }
    
    function CambiarValor(N) 
    {//N=Switch
      const xhttp = new XMLHttpRequest();
      var Mensaje;
      let Val = document.getElementById(N).checked;
      
      if (Val == true) 
      {
        document.getElementById("lbl".concat(N)).innerHTML = N.concat(" Encendido");
        Mensaje = "Anodo".concat("=1");
        SwitchOn=true;
      } 
      else 
      {
        document.getElementById("lbl".concat(N)).innerHTML = N.concat(" Apagado");
        Mensaje = "Anodo".concat("=0");
        SwitchOn=false;
      }
      
      xhttp.open("POST", Mensaje);
      xhttp.send();
      
      ActualizarVisualizacionDelColor();
      ActualizarValordelTexto();
    }
    
    function sendRGB(r, g, b) {
      
      const xhttp = new XMLHttpRequest();
      const rVal = SwitchOn ? r : 0;
      const gVal = SwitchOn ? g : 0;
      const bVal = SwitchOn ? b : 0;
      
      xhttp.open("POST", `RGB=${rVal},${gVal},${bVal}`);
      xhttp.send();
    }
    
    function PedirValores() {
      const xhttp = new XMLHttpRequest();
      
      xhttp.onload = function() {
        const Respuesta = this.responseText;
        let Valor;
        
        // Check LEDR status
        Valor = Respuesta.substr(Respuesta.indexOf("Anodo"), 7);
        if (Valor == "Anodo=1") {
          document.getElementById("Switch").checked = true;
          document.getElementById("lblSwitch").innerHTML = "Switch Encendido";
          SwitchOn = true;
        } else {
          document.getElementById("Switch").checked = false;
          document.getElementById("lblSwitch").innerHTML = "Switch Apagado";
          SwitchOn = false;
        } 
        
        // Check RGB values
        if (Respuesta.includes("RGB=")) {
          const rgbStr = Respuesta.substring(Respuesta.indexOf("RGB=") + 4);
          const vals = rgbStr.split(',');
          
          if (vals.length === 3) {
            document.getElementById('r').value = vals[0];
            document.getElementById('g').value = vals[1];
            document.getElementById('b').value = vals[2];
            document.getElementById('rv').textContent = vals[0];
            document.getElementById('gv').textContent = vals[1];
            document.getElementById('bv').textContent = vals[2];
          }
        }
        ActualizarVisualizacionDelColor();
      };
      
      xhttp.open("POST", "EnviarValoresActuales");
      xhttp.send();
      
      setTimeout(PedirValores, 10000);
    }
  </script>
</body>
</html>